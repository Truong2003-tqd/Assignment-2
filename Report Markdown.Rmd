---
title: "Code Markdown"
author: "Truong"
date: "`r Sys.Date()`"
output:
  html_document:
    toc: true
    toc_float: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(warning = TRUE, echo = TRUE)
```

# Preprocessing

## Import data

### Import libraries

```{r}
library(readr)
library(tidyverse)
library(naniar)
library(gtExtras)
library(patchwork)
library(gridExtra)
library(skimr)
library(VIM)
library(corrplot)
library(ggplot2)
library(plotly)
library(grid)
library(car)
```

### Import data

```{r}
bike_sharing_data <- read_csv("hour.csv")
```

### View data

```{r echo= TRUE}
bike_sharing_data %>% rmarkdown::paged_table()
```

### Glimpse dataset

```{r echo=TRUE}
glimpse(bike_sharing_data)
```

### Remove 'dteday'

```{r}
bike_sharing_data <- bike_sharing_data %>% 
  select(-dteday) 
```

### Skim dataset

```{r}
skim(bike_sharing_data) %>% 
  select(-c(n_missing,complete_rate)) 
```

- There 22 erroneous values in which humidity equals to equal to 0. 0% humidity is only possible in laboratory condition. The error only happened in consecutive 22 days and did not reoccur, indicating the possibility of system error. KNN is used to impute the erroneous values at a high accuracy.

```{r}
#Number of humidity error
bike_sharing_data %>% 
  filter(hum < 0.00) %>%
  summarise("Humidity Error" = n())
```


### Check duplication

```{r}
sum(duplicated(bike_sharing_data))
```

### Convert variable to 2 decimal places

```{r}
bike_sharing_data <- bike_sharing_data %>% 
  mutate(across(c('temp','atemp','hum','windspeed'),~round(.x,2)))
```

### Descriptive Summary

```{r}
summary(bike_sharing_data)
```

### Convert to factors

```{r}
bike_sharing_data <- bike_sharing_data %>% 
  mutate(across(c(season,holiday,workingday,weathersit, weekday, yr, mnth), as.factor))
```

### Convert to integer

```{r}
bike_sharing_data <- bike_sharing_data %>% 
  mutate(across(c(instant,casual,registered,cnt,hr), as.integer))
```

### Create raw temperature and raw felt temperature columns

```{r}
bike_sharing_data <- bike_sharing_data %>% 
  mutate(raw_temp = temp*47-8,
         raw_felt_temp = atemp*66-16,
         raw_windspeed = windspeed*67)
```

### Drop humidity error

```{r echo=TRUE}
bike_sharing_data <- bike_sharing_data %>% 
  filter(hum != 0)
```

### Create weekend column

```{r echo=TRUE}
bike_sharing_data <- bike_sharing_data %>% 
  mutate(weekend = case_when(
    weekday == 0 ~ 1,
    weekday == 6 ~ 1,
    TRUE ~ 0
  )) 
```

### Skim after processing

```{r}
skim(bike_sharing_data) 
```

# Outlier Detection
## 
# EDA
## Initiate questions

- Most important question for the analysis: **"How can we predict the hourly demand for bike rentals based on environmental and temporal factors (excluding long-term time trends) to optimize bike availability and resource allocation?"**

1. Are there any relationship between usage and double variables including temperature, humidity, weather, wind speed?
2. Are there any relationship between usage and factor variables including season, holiday, working day, weather?
3. Are there any relationship between usage and integer variables including year, month, hour? 
4. Are there any difference between casual and registered users? If yes, why? Can we infer something from the findings? 
5. What are usage purposes of each group? 

## Which group is the primary customers in the data?

```{r fig.height=12, fig.width=10.5}
grid.newpage()
pushViewport(viewport(layout = grid.layout(nrow = 2, ncol =1)))
#Proportion of Casual and Registered Users by Year
print(
  bike_sharing_data %>% 
  group_by(yr) %>% 
  summarise(Casual = sum(casual)*100/sum(cnt),
            Registered = sum(registered)*100/sum(cnt),
            .groups = "drop") %>% 
  pivot_longer(cols = c(Casual, Registered), names_to = "UserType", values_to = "Proportion") %>%  
  ggplot(aes(x = factor(yr), y = Proportion, fill = UserType))+
  geom_col(position = position_dodge(), width = 0.8)+
  geom_text(aes(label = round(Proportion,2)), fontface = "bold", vjust = -0.5, 
            position = position_dodge(0.8), size = 4)+
  scale_fill_manual(values = c("Casual" = "#1f77b4", "Registered" = "#ff7f0e")) +
  scale_x_discrete(label = c("0"=2011, "1"=2012))+
  labs(
    title = "Proportion of Casual and Registered Users by Year",
    x = "Year", y = "Proportion of Total Users", fill = "User Type"
  ) +
  theme_classic(),
  vp = viewport(layout.pos.row = 1, layout.pos.col = 1),
  newplot = FALSE)
#Boxplot of Usage in 2011 and 2012
print(
  bike_sharing_data %>% 
  group_by(yr) %>% 
  reframe(Casual = casual,
          Registered = registered,
          Total = cnt) %>% 
  pivot_longer(cols = c(Casual, Registered, Total), names_to = "UserType", values_to = "Usage") %>% 
  ggplot(aes(x = factor(yr), y = Usage, fill = UserType))+
  geom_boxplot()+
  scale_fill_manual(values = c("Casual" = "#1f77b4", "Registered" = "#ff7f0e", "Total" = "lightgreen")) +
  scale_x_discrete(label = c("0"=2011, "1"=2012))+
  labs(
    title = "Boxplot of Usage in 2011 and 2012",
    x = "Year", y = "Usage", fill = "User Type"
  ) +
  theme_classic(),
  vp = viewport(layout.pos.row = 2, layout.pos.col = 1),
  newplot = FALSE)
```

## Which seasons have highest usages?

```{r fig.height=12, fig.width=10.5}
grid.newpage()
pushViewport(viewport(layout = grid.layout(nrow = 2, ncol =1)))
#Proportion of Seasonal Usage across 2011 and 2012
print(
  bike_sharing_data %>% 
  group_by(yr, season) %>%
  summarise(Casual = sum(casual),
            Registered = sum(registered),
            Total = sum(cnt),
            .groups = "drop") %>%
  pivot_longer(cols = c(Casual, Registered, Total),
               names_to = "UserType",
               values_to = "Total") %>%
  group_by(yr, UserType) %>%
  mutate(Proportion = (Total / sum(Total)) * 100) %>%
  ungroup() %>%  
  ggplot(aes(x = factor(season), y = Proportion, fill = UserType))+
  geom_col(position = position_dodge(), width = 0.8)+
  geom_text(aes(label = round(Proportion,2)), fontface = "bold", vjust = -0.25, 
            position = position_dodge(0.8), size = 3)+
  scale_fill_manual(values = c("Casual" = "#1f77b4", "Registered" = "#ff7f0e", "Total" = "lightgreen")) +
  scale_x_discrete(label = c("1"="Winter", "2"="Spring", "3"="Summer", "4"="Fall"))+
  labs(
    title = "Proportion of Seasonal Usage across 2011 and 2012",
    x = "Season", y = "Proportion of Total Users", fill = "User Type") +
  facet_grid(yr~UserType,
             labeller = labeller(
               yr =  c(`0` = "2011", `1` = 2012)
             ))+
  theme_classic(),
  vp = viewport(layout.pos.row = 1, layout.pos.col = 1),
  newplot = FALSE)
#Boxplot of Seasonal Usage across 2011 and 2012
print(
  bike_sharing_data %>% 
  group_by(yr, season) %>%
  reframe(Casual = casual,
            Registered = registered,
            Total = cnt) %>%
  pivot_longer(cols = c(Casual, Registered, Total),
               names_to = "UserType",
               values_to = "Usage") %>%
  ggplot(aes(x = factor(season), y = Usage, fill = UserType))+
  geom_boxplot()+
  scale_fill_manual(values = c("Casual" = "#1f77b4", "Registered" = "#ff7f0e", "Total" = "lightgreen")) +
  scale_x_discrete(label = c("1"="Winter", "2"="Spring", "3"="Summer", "4"="Fall"))+
  labs(
    title = "Boxplot of Seasonal Usage across 2011 and 2012",
    x = "Season", y = "Proportion of Total Users", fill = "User Type") +
  facet_grid(yr~UserType,
             labeller = labeller(
               yr =  c(`0` = "2011", `1` = 2012)
             ))+
  theme_classic(),
  vp = viewport(layout.pos.row = 2, layout.pos.col = 1),
  newplot = FALSE)
```


## Which months have highest usages?

```{r fig.height=10.5, fig.width=9.5}
bike_sharing_data %>% 
  group_by(yr, mnth) %>% 
  summarise(Casual = sum(casual),
            Registered = sum(registered),
            .groups = "drop") %>%
  pivot_longer(cols = c(Casual, Registered), names_to = "UserType", values_to = "Total") %>%  
  group_by(yr, UserType) %>% 
  mutate(Proportion = Total*100/sum(Total)) %>%
  ungroup() %>% 
  ggplot(aes(x = factor(mnth), y = Proportion, fill = UserType))+
  geom_col(position = position_dodge(0.9), width = 0.8)+
  geom_text(aes(label = round(Proportion,2)), fontface = "bold", vjust = -0.5, 
            position = position_dodge(0.9), size = 2.8)+
  scale_fill_manual(values = c("Casual" = "#1f77b4", "Registered" = "#ff7f0e")) +
  labs(
    title = "Proportion of Monthly Usage across 2011 and 2012",
    x = "Month", y = "Proportion of Total Users", fill = "User Type"
  ) +
  facet_grid(yr~UserType,
             labeller = labeller(
               yr =  c(`0` = "2011", `1` = 2012)
             ))+
  theme_classic()
```

## Which weekday have highest usages?

```{r fig.height=10.5, fig.width=9.5}
bike_sharing_data %>% 
  group_by(yr, weekday) %>% 
  summarise(Casual = sum(casual),
            Registered = sum(registered),
            .groups = "drop") %>%
  pivot_longer(cols = c(Casual, Registered), names_to = "UserType", values_to = "Total") %>%  
  group_by(yr, UserType) %>% 
  mutate(Proportion = Total*100/sum(Total)) %>%
  ungroup() %>%  
  ggplot(aes(x = factor(weekday), y = Proportion, fill = UserType))+
  geom_col(position = position_dodge(), width = 0.8)+
  geom_text(aes(label = round(Proportion,2)), fontface = "bold", vjust = -0.5, 
            position = position_dodge(0.9), size = 2.8)+
  scale_fill_manual(values = c("Casual" = "#1f77b4", "Registered" = "#ff7f0e"))+
  labs(
    title = "Proportion of Daily Usage across 2011 and 2012",
    x = "Weekday", y = "Proportion of Total Users", fill = "User Type"
  ) +
  facet_grid(yr~UserType,
             labeller = labeller(
               yr =  c(`0` = "2011", `1` = 2012)
             ))+
  theme_classic()
```
## Which hours have highest usages?
### In each year

```{r fig.height=10.5, fig.width=9.5}
bike_sharing_data %>% 
  group_by(yr, hr) %>% 
  summarise(Casual = sum(casual),
            Registered = sum(registered),
            .groups = "drop") %>%
  pivot_longer(cols = c(Casual, Registered), names_to = "UserType", values_to = "Total") %>%  
  group_by(yr, UserType) %>% 
  mutate(Proportion = Total*100/sum(Total)) %>%
  ungroup() %>%    
  ggplot(aes(x = factor(hr), y = Proportion, fill = UserType))+
  geom_col(position = position_dodge(), width = 0.8)+
  scale_x_discrete(breaks = c(0,6,12,18,23))+
  scale_fill_manual(values = c("Casual" = "#1f77b4", "Registered" = "#ff7f0e")) +
  labs(
    title = "Proportion of Hourly Usage across 2011 and 2012",
    x = "Hours", y = "Proportion of Total Users", fill = "User Type"
  ) +
  facet_grid(yr~UserType)+
  theme_classic()
```

### In each week day

```{r fig.height=10.5, fig.width=9.5}
bike_sharing_data %>% 
  group_by(weekday, hr) %>% 
  summarise(Casual = sum(casual),
            Registered = sum(registered),
            .groups = "drop") %>%
  pivot_longer(cols = c(Casual, Registered), names_to = "UserType", values_to = "Total") %>%  
  group_by(weekday, UserType) %>% 
  mutate(Proportion = Total*100/sum(Total)) %>%
  ungroup() %>%    
  ggplot(aes(x = factor(hr), y = Proportion, fill = UserType))+
  geom_col(position = position_dodge(), width = 0.8)+
  scale_x_discrete(breaks = c(0,6,12,18,23))+
  scale_fill_manual(values = c("Casual" = "#1f77b4", "Registered" = "#ff7f0e")) +
  labs(
    title = "Proportion of Hourly Usage across 2011 and 2012",
    x = "Hours", y = "Proportion of Total Users", fill = "User Type"
  ) +
  facet_grid(weekday~UserType)+
  theme_classic()
```

### In each day type

```{r fig.height=10.5, fig.width=9.5}
bike_sharing_data %>%
  group_by(hr, workingday, holiday) %>%
  summarise(Casual = sum(casual),
            Registered = sum(registered),
            .groups = "drop") %>%
  pivot_longer(cols = c(Casual, Registered), names_to = "UserType", values_to = "Total") %>%
  group_by(holiday, workingday) %>% 
  mutate(Proportion = Total * 100 / sum(Total)) %>%
  ungroup() %>%
  ggplot(aes(x = hr, y = Proportion, color = UserType)) + 
  geom_line(linewidth = 1) +
  scale_color_manual(values = c("Casual" = "#1f77b4", "Registered" = "#ff7f0e")) +
  geom_point(size = 2) + 
  theme_classic() +
  labs(title = 'Proportion of Hourly Usage across Day Type', 
       x = "Hour", y = "Proportion of Total Users (%)", color = "User Type") + 
  facet_grid(
    holiday ~ workingday,
    labeller = labeller(
      workingday = c(`0` = "Non-working Day", `1` = "Working Day"),
      holiday = c(`0` = "Non-Holiday", `1` = "Holiday")
    )
  ) 
```

## Categorize hours

- Hours are categorized based on the periods of human daily activities
- Late_Night: (0 - 4) - Minimal activity, sleep period.
- Early_Morning: (5 - 6) - Pre-commute activity starts.
- Morning_Peak: (7 - 9) - Commute/start of day rush.
- Midday: (10 - 16) - Core working/leisure hours, includes lunch.
- Afternoon_Peak: (17 - 19) - End of work/evening commute rush.
- Evening: (20 - 23) - Post-commute leisure, dinner time.

```{r}
#Create intervals and labels
hour_interval <- c(0,5,7,10,17,20,Inf)
hour_label <- c("LateNight", "EarlyMorning", "MorningPeak", "Midday", "AfternoonPeak", "Evening")

#Create hour category variable
bike_sharing_data <- bike_sharing_data %>% 
  mutate(hr_cat =  cut(hr, breaks = hour_interval, labels = hour_label, right = FALSE)) 
```

### Average Usage of Each User Type by Hour Block

-   Registered users may primarily use for work travelling purposes, indicating most of them are office workers or students.
-   Casual users may be tourists, university students, who have flexible studying hours.
-   **Difference in usage distribution can partly infer customer demographic of the company**

```{r}
bike_sharing_data %>%
  group_by(hr_cat) %>%
  summarise(Casual = mean(casual),
            Registered = mean(registered),
            .groups = "drop") %>%
  pivot_longer(cols =  c(Casual, Registered), names_to = "UserType", values_to = "Average") %>% 
  ggplot(aes(x = hr_cat, y = Average, fill =UserType)) +
  geom_col(position = position_dodge(), width = 0.8) +
  scale_y_continuous(labels = scales::comma) +
  scale_fill_manual(values = c("Casual" = "#1f77b4", "Registered" = "#ff7f0e")) +
  labs(title = "Average Usage of Each Hour Block by Each User Type",
       x = "Hour Block",
       y = "Average Usage")+
  facet_grid(UserType~.)+
  theme_classic()+
 bike_sharing_data %>%
  group_by(hr_cat) %>%
  summarise(Casual = sum(casual),
            Registered = sum(registered),
            .groups = "drop") %>%
  pivot_longer(cols =  c(Casual, Registered), names_to = "UserType", values_to = "Total") %>% 
  group_by(UserType) %>% 
  mutate(Proportion = Total * 100 / sum(Total)) %>% 
  ggplot(aes(x = hr_cat, y = Proportion, fill =UserType)) +
  geom_col(position = position_dodge(), width = 0.8) +
  scale_y_continuous(labels = scales::comma) +
  scale_fill_manual(values = c("Casual" = "#1f77b4", "Registered" = "#ff7f0e")) +
  labs(title = "Proportion of Each Hour Block by Each User Type",
       x = "Hour Block",
       y = "Proportion")+
  facet_grid(UserType~.)+
  theme_classic() 
```

### Usage in Working Day and Holiday 

- There are differences in average usage and usage distribution between interaction of day type. Therefore, the regression should include the interaction term of `hr_cat` and `workingday`, and `hr_cat` and `holiday` to demonstrate the impact of day type in usage at each hour block.
- **The difference between day type consolidate the assumption in the above chart.**

```{r fig.height=7, fig.width=10.5}
bike_sharing_data %>%
  group_by(hr_cat, workingday, holiday) %>%
  summarise(Casual = mean(casual),
            Registered = mean(registered),
            .groups = "drop") %>%
  pivot_longer(cols = c(Casual, Registered), names_to = "UserType", values_to = "Average") %>%
  ggplot(aes(x = hr_cat, y = Average, fill = UserType)) + 
  geom_col(position = position_dodge(), width = 0.8) +
  scale_y_continuous(labels = scales::comma) +
  scale_fill_manual(values = c("Casual" = "#1f77b4", "Registered" = "#ff7f0e")) +
  theme_classic() +
  labs(title = 'Average of Hourly Usage across Day Type', 
       x = "Hour Block", y = "Average Usage", color = "User Type") + 
  facet_grid(
    holiday ~ workingday,
    labeller = labeller(
      workingday = c(`0` = "Non-working Day", `1` = "Working Day"),
      holiday = c(`0` = "Non-Holiday", `1` = "Holiday")
    )
  ) +
bike_sharing_data %>%
  group_by(hr_cat, weekend, holiday) %>%
  summarise(Casual = mean(casual),
            Registered = mean(registered),
            .groups = "drop") %>%
  pivot_longer(cols = c(Casual, Registered), names_to = "UserType", values_to = "Average") %>%
  ggplot(aes(x = hr_cat, y = Average, fill = UserType)) + 
  geom_col(position = position_dodge(), width = 0.8) +
  scale_y_continuous(labels = scales::comma) +
  scale_fill_manual(values = c("Casual" = "#1f77b4", "Registered" = "#ff7f0e")) +
  theme_classic() +
  labs(title = 'Average of Hourly Usage across Day Type', 
       x = "Hour Block", y = "Average Usage", color = "User Type") + 
  facet_grid(
    holiday ~ weekend,
    labeller = labeller(
      weekend = c(`0` = "Weekday", `1` = "Weekend"),
      holiday = c(`0` = "Non-Holiday", `1` = "Holiday")
    )
  ) 
```

### Average Usage in Each Weekday Across 4 Seasons
- See no difference between distribution of average usage in each weekday across 4 seasons. 
- **No interaction between `weekday` and `season`**

```{r fig.height=10, fig.width=12.5}
bike_sharing_data %>%
  group_by(hr_cat, weekday, season) %>%
  summarise(Casual = mean(casual),
            Registered = mean(registered),
            .groups = "drop") %>%
  pivot_longer(cols = c(Casual, Registered), names_to = "UserType", values_to = "Average") %>%
  ggplot(aes(x = hr_cat, y = Average, fill = UserType)) + 
  geom_col(position = position_dodge(), width = 0.8) +
  scale_y_continuous(labels = scales::comma) +
  scale_fill_manual(values = c("Casual" = "#1f77b4", "Registered" = "#ff7f0e")) +
  labs(title = 'Average Usage in Each Weekday Across 4 Seasons', 
       x = "Hour Block", y = "Average of Total Users", color = "User Type") + 
  facet_grid(
     ~ season
  )+
  theme_classic() 
```
# Correlation

```{r}
#Create correlation dataframe
correlation_df <- bike_sharing_data
```

```{r}
#Glimpse
glimpse(correlation_df) 
```

## Correlation plot with numeric variables

- Select raw_felt_temp
- Select raw_windspeed
- Select humidity

```{r}
#Create correlation table with numeric value
num_correl_table <- correlation_df %>%
  select(cnt,casual,registered,raw_felt_temp,raw_windspeed,hum) %>% 
  cor(.)

#Create correlation plot
corrplot(num_correl_table, 
         method = "color", 
         type = "lower",
         addCoef.col = "#0F4761",
         number.cex = 0.8,
         tl.col = "#0F4761", 
         tl.srt = 30) 
```

## Correlation plot with ordinal variables
- **Independent variable selection:**
1. **Weekday:** There are distinct differences between Mon to Fri and Sar to Sun in registered users. However, the differences are demonstrated are also demonstrated by `workingday`. **(Consider to do ANOVA test between Mon to Fri and Sar and Sun)**. Use `workingday` to ensure the simplicity of the model. 
2. **Season:** Season shows weak linear relationship but there are differences in usage between seasons.
3. **Working day:** Selected 


```{r}
#Create correlation table with ordinal value
ordinal_correl_table <- correlation_df %>% 
  mutate(season = as.numeric(season),
         workingday = as.numeric(workingday),
         holiday = as.numeric(holiday),
         hr_cat = as.numeric(hr_cat),
         weathersit = as.numeric(weathersit),
         weekend = as.numeric(weekend)) %>% 
  select(cnt,casual,registered,season,weekend,holiday,weathersit,hr_cat) %>% 
  cor(., method = "spearman")

#Create correlation plot
corrplot(ordinal_correl_table, 
         method = "color", 
         type = "lower",
         addCoef.col = "#0F4761",
         number.cex = 0.8,
         tl.col = "#0F4761", 
         tl.srt = 30) 
```

## Correlation plot with all variables using Spearman method

```{r}
#All variables correlation plot
all_correl_table <- correlation_df %>% 
  mutate(season = as.numeric(season),
         weekend = as.numeric(weekend),
         holiday = as.numeric(holiday),
         hr_cat = as.numeric(hr_cat),
         weathersit = as.numeric(weathersit)) %>% 
  select(cnt,casual,registered,season,weekend,holiday,weathersit,hr_cat, raw_felt_temp, hum, raw_windspeed) %>% 
  cor(., method = "spearman")

corrplot(all_correl_table, 
         method = "color", 
         type = "lower",
         addCoef.col = "#0F4761",
         number.cex = 0.8,
         tl.col = "#0F4761", 
         tl.srt = 30) 
```


# Regression

## Casual linear regression

1. Baseline model 

```{r}
lm(log(casual+1)~
     factor(hr_cat)+
     factor(weekend)+
     factor(weathersit)+
     factor(season)+
     factor(holiday)+
     hum+
     raw_felt_temp
     ,
   data = bike_sharing_data) %>%
  summary()
```


2. Interaction model

```{r}
#Interaction model
lm(log(casual+1)~
     factor(hr_cat)*
     factor(weekend)+
     factor(weathersit)+
     factor(season)+
     hum+
     raw_felt_temp+
     factor(holiday)
   ,
   data = bike_sharing_data) %>% 
  summary()
```

## Registered linear regression

1. Baseline model 

```{r}
#Baseline model (R-squared  = 0.71)
lm(log(registered+1)~
     factor(hr_cat)+
     factor(weekend)+
     factor(weathersit)+
     factor(season)+
     factor(holiday)+
     hum+
     atemp
   ,
   data = bike_sharing_data) %>% 
  summary()
```

2. Interaction model

```{r}
#Interaction model (R-squared = 0.81)
lm(log(registered+1)~
     factor(hr_cat)*factor(weekend)+
     factor(weathersit)+
     factor(season)+
     factor(holiday)+
     hum+
     raw_felt_temp
   ,
   data = bike_sharing_data) %>% 
  summary()
```
















